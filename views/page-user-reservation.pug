extends layouts/_layout.pug

block variables
	- var activePage = 'register-page'
	- var activeGroup = 'pages'
	- var i = 1

block title
	title #{title} | Danish - Thai Gala

block content
	section.material-half-bg
		.cover
		include includes/_errorMessage.pug
	section.container
		h2.text-center.top-buffer.text-white #{title}
		br


		form#reservationForm.form-main
			.col-md-12
				.tile
					h3.tile-title 1. Select seats number
					hr
					.tile-body
						.form.row
							.form-group.col-md-12
								.alert.alert-danger(role='alert', id="msgDiv")
						.form.row

							.form-group.col-md-4
								- var n = 1;
								select#getSeats.form-control(name='seat')
									while n <= 10
										option(value=n)= n++
							.form-group.col-md-4
							.form-group.col-md-4
		
			.col-md-12
				.tile
					h3.tile-title 2. Reservation
					hr
					.tile-body
						- for (var i=0; i<10; i++)
							.form-row.reservationUser(id="reservation-"+i)
								.form-group.col-md-3
									label.control-label First Name
									input.form-control(type="text", placeholder="Enter your name", name="reservations["+i+"][firstName]" data-value-type="auto")
								.form-group.col-md-3
									label.control-label Last Name
									input.form-control(type="text", placeholder="Enter your name" name="reservations["+i+"][lastName]" data-value-type="auto")
								.form-group.col-md-3
									label.control-label Email
									input.form-control(type="text", placeholder="Enter your email" name="reservations["+i+"][email]" data-value-type="auto")
								.form-group.col-md-3
									label.control-label(for='food') Meal Preference
									mixin food(name)
										option.food&attributes(attributes)= name
									select#food.form-control(name="reservations["+i+"][food]" data-value-type="auto")
										+food('Hindu Meals')
										+food('Vegetarian Meals')(selected)
										+food('Seafood Meals')
										+food('Child Meals') #{i+1}

			.col-md-12
				.tile
					h3.tile-title 3. Check Out
					hr
					.tile-body
						.form.row
							.form-group.col-md-4.text-center
								.input-group.input-group-lg
									.input-group-prepend
										span.input-group-text à¸¿
									input#inputPrice.form-control.text-right(type='text', aria-label='Amount (to the nearest THB)', value="", name="amount")
									.input-group-append
										span.input-group-text .00
							.form-group.col-md-4.text-center
								#paypal-button-container
							.form-group.col-md-4.text-center
								button#btn-bank-foobar.btn.btn-primary(type="submit")
									i.fa.fa-fw.fa-lg.fa-check-circle
									| Purchase via Bank Transfer
								p.text-center
								| Account holder: Danish-Thai Chamber of Commerce
								br
								| Bank name: Bangkok Bank
								br
								| Branch: Ratchathewi
								br
								| Account number: 123-318207-8
								br
								| Swift code: BKKBTHBK

			if invoicereceipt
				.col-md-12
					.tile
						h3.tile-title 4. Activities
						.tile-body
							table.table
								thead
									tr
										th Invoice
										th Date
										th Statue
										th Action
								tbody
									//- each users in accounts
									//- tr
									//- 	td #{users.user.name}
									//- 	td #{users.user.email}
									//- 	each app in application
									//- 		td #{app.language}
									//- 		td #{app.app_id}
block specific-js
	script(type='text/javascript').

		// A $( document ).ready() block.
		$( document ).ready(function() {
			var numSeat = $('select#getSeats').find(":selected").val();
			$('input#inputPrice').val(numSeat*4000);
			console.log( "ready!", numSeat );
			seatsForm(numSeat);

		});

		function seatsForm(seats) {
			var reservationUser = $('.reservationUser').length
			$('.reservationUser').hide();
			var i;
			for (i = 0; i < seats; i++) { 
				$('.reservationUser').eq(i).show();
			}

		}


		$('select#getSeats').change(function(){
			var result = $('#reservationForm').serializeJSON();
			var numSeat = $(this).find(":selected").val();
			$('input#inputPrice').val(numSeat*4000);
			//- $('#output1').html('JSON: ' + JSON.stringify(result));
			seatsForm(numSeat);
		});


		$("#btn-bank-foobar").on('click', function(event){
			event.preventDefault();
			$.alert({
				title: 'Attention Please!',
				content: "<strong>Please note:</strong><br></p>Account holder: Danish-Thai Chamber of Commerce<br>Bank name: Bangkok Bank<br>Branch: Ratchathewi<br>Account number: 123-318207-8<br>Swift code: BKKBTHBK</div>",
				buttons: {
					Okey: function(){
						var numSeat = $('select#getSeats').find(":selected").val();

						results = $('#reservationForm').serializeJSON();
						resultdata = JSON.stringify(results);
						console.log(results);
						//- $('#output2').html('JSON: ' + JSON.stringify(result));
						$.ajax({
							url: "/user/reservation",
							method: "POST",
							data: {
								"invoicereceipt": invoicereceipt,
								"resevation": resevation
								}
						}).done(function( data ) {
							if ( data ) {
								if(data.status == 'error'){

									var errors = '<ul>';
									$.each( data.message, function( key, value ) {
										errors = errors +'<li>'+value.msg+'</li>';
									});
									errors = errors+ '</ul>';
									$("#msgDiv").html(errors).show();
								}else{
									//- $("#msgDiv").removeClass('alert-danger').addClass('alert-success').html(data.message).show(); 
									//- location.href = "/user/reservation";
								}
							}
						});
					}
				}
			});
		});

	
	script.
	

		var seat = $('select#getSeats').find(":selected").val();
		var total = $('input#inputPrice').val();
		var seat_price = "4000";

		paypal.Buttons({
			
			//- env: 'sandbox',
			//- client: {
			//- 	sandbox: 'AXydPsLXTdZ6adJzSh4A83aP5yRgqVzY6nOIwMHQC5M4xVkNvhR8N25mZVKAfSKzZD_7p1ZFHT5bGnZ1',
			//- 	production: 'AevfcUcud61kYUW_Kh9Dj6c6CNuA3WufU9qJlfInYRClYR_UwidM9IlYtQi0PMRZ4ujuczHKErtVXmbc'
			//- },
			style: {
				layout:  'vertical',
				color:   'blue',
				shape:   'rect',
				label:   'paypal'
			},

			createOrder: function(data, actions) {
				return actions.order.create({
					purchase_units: [{
						amount: {
							value: total,
							currency_code: 'THB',
							breakdown: {
								item_total: {value: total, currency_code: 'THB'}
							}
						},
						items: [{
							name: seat+' Reservation Seat(s)',
							unit_amount: {value: total, currency_code: 'THB'},
							quantity: seat,
							sku: 'dtcc-booking-01'
						}]
					}],
					description: 'The payment transaction description.',
					soft_descriptor: 'ECHI5786786',
				});
			},
			onApprove: function(data, actions) {
				return actions.order.capture().then(function(details) {
					alert('Transaction completed by ' + details.payer.name.given_name);
					// Call your server to save the transaction
					return fetch('/user/paypal-transaction-complete', {
						method: 'post',
						headers: {
							'content-type': 'application/json'
						},
						body: JSON.stringify({
							orderID: data.orderID
						})
					});
				});
			},
			onError: function (err) {
				console.log(err);
			}
		}).render('#paypal-button-container');
